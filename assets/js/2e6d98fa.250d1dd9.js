"use strict";(self.webpackChunkzio_site=self.webpackChunkzio_site||[]).push([[80132],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),s=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=s(e.components);return a.createElement(p.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},g=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=s(n),g=r,d=m["".concat(p,".").concat(g)]||m[g]||u[g]||o;return n?a.createElement(d,i(i({ref:t},c),{},{components:n})):a.createElement(d,i({ref:t},c))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=g;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[m]="string"==typeof e?e:r,i[1]=l;for(var s=2;s<o;s++)i[s]=n[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}g.displayName="MDXCreateElement"},99440:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var a=n(87462),r=(n(67294),n(3905));const o={id:"opentelemetry",title:"OpenTelemetry"},i=void 0,l={unversionedId:"zio-telemetry/opentelemetry",id:"zio-telemetry/opentelemetry",title:"OpenTelemetry",description:"OpenTelemetry is a collection of tools, APIs, and SDKs. You can use it to instrument, generate, collect, and export telemetry data for analysis in order to understand your software's performance and behavior. Well known implementations are Jaeger",source:"@site/docs/zio-telemetry/opentelemetry.md",sourceDirName:"zio-telemetry",slug:"/zio-telemetry/opentelemetry",permalink:"/zio-telemetry/opentelemetry",draft:!1,editUrl:"https://github.com/zio/zio/edit/series/2.x/docs/zio-telemetry/opentelemetry.md",tags:[],version:"current",frontMatter:{id:"opentelemetry",title:"OpenTelemetry"},sidebar:"ecosystem-sidebar",previous:{title:"OpenCensus",permalink:"/zio-telemetry/opencensus"},next:{title:"OpenTelemetry Example",permalink:"/zio-telemetry/opentelemetry-example"}},p={},s=[{value:"Installation",id:"installation",level:2},{value:"Usage",id:"usage",level:2},{value:"Tracing",id:"tracing",level:3},{value:"Baggage",id:"baggage",level:3},{value:"Context Propagation",id:"context-propagation",level:3},{value:"Experimental Usage with OpenTelemetry automatic instrumentation",id:"experimental-usage-with-opentelemetry-automatic-instrumentation",level:3}],c={toc:s},m="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(m,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"OpenTelemetry is a collection of tools, APIs, and SDKs. You can use it to instrument, generate, collect, and export telemetry data for analysis in order to understand your software's performance and behavior. Well known implementations are ",(0,r.kt)("a",{parentName:"p",href:"https://www.jaegertracing.io"},"Jaeger"),"\nand ",(0,r.kt)("a",{parentName:"p",href:"https://www.zipkin.io"},"Zipkin"),"."),(0,r.kt)("h2",{id:"installation"},"Installation"),(0,r.kt)("p",null,"First, add the following dependency to your build.sbt:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'"dev.zio" %% "zio-opentelemetry" % "<version>"\n')),(0,r.kt)("h2",{id:"usage"},"Usage"),(0,r.kt)("h3",{id:"tracing"},"Tracing"),(0,r.kt)("p",null,"To use ZIO Telemetry, you will need a ",(0,r.kt)("inlineCode",{parentName:"p"},"Tracing")," service in your environment. You also need to provide a ",(0,r.kt)("inlineCode",{parentName:"p"},"Tracer"),"\n(for this example we use ",(0,r.kt)("inlineCode",{parentName:"p"},"JaegerTracer.live")," from ",(0,r.kt)("inlineCode",{parentName:"p"},"opentelemetry-example")," module) and ",(0,r.kt)("inlineCode",{parentName:"p"},"ContextStorage")," implementation."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-scala"},'import zio.telemetry.opentelemetry.tracing.Tracing\nimport zio.telemetry.opentelemetry.context.ContextStorage\nimport zio.telemetry.opentelemetry.example.JaegerTracer\nimport io.opentelemetry.api.trace.{ SpanKind, StatusCode }\nimport zio._\n\nval errorMapper = ErrorMapper[Throwable]{ case _ => StatusCode.UNSET }\n\nval app =\n  ZIO.serviceWithZIO[Tracing] { tracing =>\n    // import available aspects to create spans conveniently\n    import tracing.aspects._\n\n    val zio = for {\n      // set an attribute to the current span\n      _       <- tracing.setAttribute("zio", "telemetry")\n      // add an event to the current span\n      _       <- tracing.addEvent("before readline")\n      // some logic\n      message <- Console.readline\n      // add another event to the current span\n      _       <- tracing.addEvent("after readline")\n    } yield message\n    \n    // create a root span out of `zio`\n    zio @@ root("root span", SpanKind.INTERNAL, errorMapper)\n    \n  }.provide(Tracing.live, ContextStorage.fiberRef, JaegerTracer.live)\n')),(0,r.kt)("h3",{id:"baggage"},"Baggage"),(0,r.kt)("p",null,"To use Baggage API, you also will need a ",(0,r.kt)("inlineCode",{parentName:"p"},"Baggage")," service in your environment. You also need to provide\n",(0,r.kt)("inlineCode",{parentName:"p"},"ContextStorage")," implementation."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-scala"},'import zio.telemetry.opentelemetry.baggage.Baggage\nimport zio.telemetry.opentelemetry.baggage.propagation.BaggagePropagator\nimport zio.telemetry.opentelemetry.context.ContextStorage\nimport zio._\n\n val app = \n  ZIO.serviceWithZIO[Baggage] { baggage => \n    val carrier = OutgoingContextCarrier.default()\n  \n    for {\n      // add new key/value into the baggage of current tracing context\n      _ <- baggage.set("zio", "telemetry")\n      // import current baggage data into carrier so it can be used by downstream consumer\n      _ <- baggage.inject(BaggagePropagator.default, carrier)\n    } yield ()\n    \n    for {\n      // extract current baggage data from the carrier\n      _    <- baggage.extract(BaggagePropagator.default, IncomingContextCarrier.default(carrier.kernel))  \n      // get value from the extracted baggage\n      data <- baggage.get("zio")\n    } yield data\n  }.provide(Baggage.live, ContextStorage.fiberRef)\n')),(0,r.kt)("h3",{id:"context-propagation"},"Context Propagation"),(0,r.kt)("p",null,"To propagate contexts across process boundaries, extraction and injection can be\nused. The current span context is injected into a carrier, which is passed\nthrough some side channel to the next process. There it is extracted back and a\nchild span of it is started."),(0,r.kt)("p",null,"Due to the use of the (mutable) OpenTelemetry carrier APIs, injection and extraction\nare not referentially transparent."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-scala"},'ZIO.serviceWithZIO[Tracing] { tracing =>\n  import tracing.aspects._\n  \n  val propagator = TraceContextPropagator.default\n  val kernel     = mutable.Map().empty\n  \n  tracing.inject(propagator, OutgoingContextCarrier.default(kernel)) @@ root("span of upstream service") *>\n    extractSpan(propagator, IncomingContextCarrier.default(kernel), "span of downstream service")\n}\n')),(0,r.kt)("h3",{id:"experimental-usage-with-opentelemetry-automatic-instrumentation"},"[Experimental]"," Usage with OpenTelemetry automatic instrumentation"),(0,r.kt)("p",null,"OpenTelemetry provides\na ",(0,r.kt)("a",{parentName:"p",href:"https://opentelemetry.io/docs/instrumentation/java/automatic/"},"JVM agent for automatic instrumentation")," which\nsupports\nmany ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/open-telemetry/opentelemetry-java-instrumentation/blob/main/docs/supported-libraries.md"},"popular Java libraries"),"\n."),(0,r.kt)("p",null,"This automatic instrumentation relies on the default OpenTelemetry context storage which is based on ",(0,r.kt)("inlineCode",{parentName:"p"},"ThreadLocal"),". So\nit doesn't work with ZIO out of the box."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"zio-opentelemetry")," provides an experimental version of ",(0,r.kt)("inlineCode",{parentName:"p"},"Tracing")," which bidirectionally propagates tracing context\nbetween ZIO and non-ZIO code, enabling interoperability with ",(0,r.kt)("em",{parentName:"p"},"most")," libraries that use the default OpenTelemetry context\nstorage."),(0,r.kt)("p",null,"To enable this experimental propagation, you will need to create ",(0,r.kt)("inlineCode",{parentName:"p"},"Tracing")," using ",(0,r.kt)("inlineCode",{parentName:"p"},"Tracing.propagating")," constructor (\ninstead of ",(0,r.kt)("inlineCode",{parentName:"p"},"Tracing.live"),")."),(0,r.kt)("p",null,"Please note that whether context propagation will work correctly depends on which specific ZIO wrappers around non-ZIO\nlibraries you are using. So please, test your specific setup."),(0,r.kt)("p",null,"It was reported that it works with:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"zhttp")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sttp")," with Java 11+ HTTP client backend"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"zio-kafka")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"doobie")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"redis4cats"))),(0,r.kt)("p",null,"It was reported that it does not work with:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sttp")," with ",(0,r.kt)("inlineCode",{parentName:"li"},"armeria")," backend")))}u.isMDXComponent=!0}}]);